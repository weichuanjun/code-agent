# Javaコード分析・設計書自動生成システム README

## 1. 概要

当システムは、指定されたJava（特にSpring BootとJPAを利用したプロジェクト）のコードベースを分析し、API設計書およびデータベース設計書を自動生成するAI搭載ツールです。
生成されるドキュメントには、Mermaid形式の図（シーケンス図、ER図など）が含まれ、プロジェクトの理解とドキュメント作成の効率化を支援します。

## 2. 主な機能

*   Javaプロジェクトのソースコード（.javaファイル）の自動読み取りと分析。
*   プロジェクトのディレクトリ構造の可視化。
*   コード内のAPIエンドポイント（コントローラなど）の特定。
*   コード内のデータベースエンティティ（JPAエンティティなど）の特定。
*   APIエンドポイントごとの詳細なAPI設計書（Markdown形式）の生成。
    *   リクエスト/レスポンス形式、パラメータ、HTTPメソッド、パスなど。
    *   関連するMermaidシーケンス図。
*   データベース全体の詳細なデータベース設計書（Markdown形式）の生成。
    *   テーブル定義、カラム情報、リレーションシップなど。
    *   Mermaid ER図。
*   生成されたドキュメントのローカルへの保存機能（プロジェクト概要、各API設計書、データベース設計書を個別のフォルダに分類）。
*   Streamlitを利用したウェブベースのユーザーインターフェース。
*   設定ファイル (`configs/app_config.yaml`) によるLLMモデル、プロンプト、UIテキストのカスタマイズ。
*   `.env` ファイルによるAPIキーの安全な管理。

## 3. システム構成

本システムは、複数のAutogen Agentが連携して動作します。

### 3.1. Agent紹介

*   **`StreamlitUserProxyAgent`**:
    *   役割: Streamlitで構築されたユーザーインターフェースとバックエンドのAutogen Agent群との間の対話を仲介します。
    *   機能: ユーザーからの入力（コードベースのパスなど）を受け取り、他のAgentに処理を依頼し、結果をUIに表示します。ユーザーの代わりにAgentと対話します。

*   **`CodebaseAnalyzerAgent`**:
    *   役割: 指定されたJavaコードベースを分析し、構造化された情報を抽出します。
    *   機能:
        *   プロジェクトのディレクトリ構造、Javaファイルリストを解釈します。
        *   ソースコードを読み取り、APIエンドポイントの定義（例: `@RestController`, `@GetMapping` など）やデータベースエンティティの定義（例: `@Entity`）を特定します。
        *   APIリスト、エンティティリストなどの概要情報を、後続のAgentが利用しやすい形式で出力します。

*   **`APIDesignGeneratorAgent`**:
    *   役割: `CodebaseAnalyzerAgent` の分析結果に基づき、個々のAPIエンドポイントに対応する詳細なAPI設計書を生成します。
    *   機能:
        *   特定された各APIエンドポイントの情報（HTTPメソッド、パス、関連するメソッドシグネチャ、コメントなど）を入力として受け取ります。
        *   APIの目的、リクエストパラメータ、レスポンス形式、エラーハンドリング、認証方式、関連するシーケンス図（Mermaid形式）などを含む、包括的なAPI設計書（Markdown形式）を生成します。

*   **`DBDesignGeneratorAgent`**:
    *   役割: `CodebaseAnalyzerAgent` の分析結果に基づき、データベース全体の設計書を生成します。
    *   機能:
        *   特定されたデータベースエンティティのリスト（クラス名、フィールド、アノテーションなど）を入力として受け取ります。
        *   テーブル定義、カラム属性（型、制約など）、リレーションシップ、インデックス、そしてER図（Mermaid形式）を含む、包括的なデータベース設計書（Markdown形式）を生成します。

### 3.2. 分析・設計書生成フロー

1.  **ユーザー入力**: ユーザーはStreamlit UIを通じて、分析対象のJavaプロジェクトのルートディレクトリへの絶対パスを指定し、「分析開始」ボタンをクリックします。
2.  **プロジェクトスキャン**:
    *   システムは指定されたパスからディレクトリ構造とJavaファイルのリストを取得します。
    *   この情報は「プロジェクト概要」としてUIに表示されます。
3.  **コードベース分析 (`CodebaseAnalyzerAgent`)**:
    *   `StreamlitUserProxyAgent` は、プロジェクト情報（ディレクトリ構造、ファイルリスト、一部のファイル内容の抜粋など）を `CodebaseAnalyzerAgent` に渡します。
    *   `CodebaseAnalyzerAgent` はLLMを利用してコードを分析し、APIエンドポイントのリスト、データベースエンティティのリスト、およびその他の関連情報を構造化されたテキストとして出力します。この結果はUIの「初期分析結果」タブに表示されます。
4.  **API設計書生成 (`APIDesignGeneratorAgent`)**:
    *   `StreamlitUserProxyAgent` は、`CodebaseAnalyzerAgent` が出力した分析レポート（特にAPIエンドポイントのリストと各APIの詳細情報）を `APIDesignGeneratorAgent` に渡します。
    *   `APIDesignGeneratorAgent` は、検出された各APIエンドポイントに対して個別に、詳細なAPI設計書を生成します。
    *   生成された各API設計書は、UIの「API仕様書」タブにAPIごとに表示されます。
5.  **データベース設計書生成 (`DBDesignGeneratorAgent`)**:
    *   `StreamlitUserProxyAgent` は、`CodebaseAnalyzerAgent` が出力した分析レポート（特にデータベースエンティティのリスト）を `DBDesignGeneratorAgent` に渡します。
    *   `DBDesignGeneratorAgent` は、これらの情報に基づいてデータベース全体の設計書（ER図を含む）を生成します。
    *   生成されたデータベース設計書は、UIの「データベース設計書」タブに表示されます。
6.  **結果の表示と保存**:
    *   全ての生成物はUI上で確認できます。
    *   ユーザーは「一括保存」ボタンをクリックすることで、生成された全てのドキュメント（プロジェクト概要、各API設計書、データベース設計書）を、アプリケーションのルートディレクトリ直下に作成されるタイムスタンプ付きのフォルダ内に、カテゴリ別に保存できます。

## 4. 使用方法

### 4.1. 前提条件

*   Python 3.9 以降
*   pip (Pythonパッケージインストーラー)
*   OpenAI APIキー (環境変数として設定)
*   Git (ソースコードをクローンする場合)

### 4.2. インストール手順

1.  **リポジトリのクローン (任意)**:
    ```bash
    git clone <repository_url>
    cd <repository_directory>
    ```

2.  **Python仮想環境の作成と有効化 (推奨)**:
    ```bash
    python -m venv venv
    source venv/bin/activate  # macOS/Linux
    # venv\Scripts\activate    # Windows
    ```

3.  **依存関係のインストール**:
    プロジェクトのルートディレクトリにある `requirements.txt` を使用して、必要なPythonパッケージをインストールします。
    ```bash
    pip install -r requirements.txt
    ```

4.  **`.env` ファイルの作成**:
    プロジェクトのルートディレクトリに `.env` という名前のファイルを作成し、以下のようにOpenAI APIキーを記述します。
    ```env
    OPENAI_API_KEY="your_openai_api_key_here"
    ```
    `your_openai_api_key_here` をご自身のAPIキーに置き換えてください。

### 4.3. アプリケーションの起動

プロジェクトのルートディレクトリで以下のコマンドを実行します。
```bash
streamlit run app.py
```
これにより、デフォルトのウェブブラウザでStreamlitアプリケーションが開きます。

### 4.4. 操作ガイド

1.  **分析対象の指定**:
    *   アプリケーションが開くと、「分析対象のJavaコードベースへの絶対パス:」という入力フィールドが表示されます。
    *   ここに、分析したいJavaプロジェクトのルートディレクトリへの絶対パスを入力します (例: `/Users/username/my-java-project`)。

2.  **分析の開始**:
    *   パスを入力後、「🚀 分析開始」ボタンをクリックします。
    *   分析処理が開始され、進捗状況が画面に表示されます。処理には数分かかる場合があります。

3.  **結果の確認**:
    *   分析が完了すると、「生成された設計ドキュメント」セクションに結果が表示されます。
    *   以下のタブで各情報を確認できます。
        *   **プロジェクト概要**: ディレクトリ構造と検出されたJavaファイルのリスト。
        *   **初期分析結果 (Agent応答)**: `CodebaseAnalyzerAgent` による生の分析レポート。
        *   **API仕様書**: 検出されたAPIエンドポイントごとに生成された設計書。各APIは個別のサブタブで表示されます。Mermaid図もここにレンダリングされます。
        *   **データベース設計書**: 生成されたデータベーススキーマ情報とER図。Mermaid図もここにレンダリングされます。

4.  **設計書の保存**:
    *   分析対象のパスが入力されており、かつ何らかのドキュメントが生成された後、「📦 一括保存」ボタンが有効になります。
    *   このボタンをクリックすると、現在表示されている全ての設計書（プロジェクト概要、全てのAPI仕様書、データベース設計書）が、この`code-agent`（アプリケーションのルート）ディレクトリ直下に `generated_design_documents_YYYYMMDD_HHMMSS` という名前のフォルダ内に保存されます。
    *   保存先のフォルダ内は、さらに `project_overview`, `api_specifications`, `database_design` というサブフォルダに分類され、各ドキュメントがMarkdownファイルとして格納されます。

## 5. 配置文件 (`configs/app_config.yaml`)

このファイルでは、システム全体の動作に関わる設定を行います。

*   **`llm_config`**:
    *   `model`: 使用するOpenAIモデル名 (例: `gpt-4o-mini`)。
    *   `temperature`: 生成結果の多様性を制御するパラメータ。
*   **`agent_configs`**:
    *   各Agent (`codebase_analyzer`, `api_design_generator`, `db_design_generator`) のシステムプロンプト (`system_message_ja`) を定義します。これにより、Agentの振る舞いや出力形式を日本語で細かく指示できます。
*   **`ui_texts`**:
    *   Streamlit UIに表示される各種テキスト（ボタンのラベル、タイトル、エラーメッセージなど）を日本語で定義します。
*   **`output_settings`**:
    *   設計書を保存する際のデフォルトのディレクトリ名やサブディレクトリ名を指定します。

設定を変更した場合は、Streamlitアプリケーションを再起動する必要がある場合があります。

## 6. 注意事項とトラブルシューティング

*   **OpenAI APIキー**: 有効なOpenAI APIキーが `.env` ファイルに正しく設定されていることを確認してください。キーがない場合や無効な場合は、Agentが動作しません。
*   **処理時間**: 大規模なコードベースを分析する場合、LLMとの通信や処理に時間がかかることがあります。
*   **Mermaid図の表示**: Mermaid図が正しく表示されない場合は、生成されたMermaidコードに構文エラーがないか確認してください。StreamlitのMarkdownレンダリング機能に依存しています。
*   **分析の品質**: 生成される設計書の品質は、LLMの能力と提供されるプロンプトの質に大きく依存します。`configs/app_config.yaml` 内のプロンプトを調整することで、出力内容を改善できる可能性があります。
*   **Javaプロジェクトの構造**: このシステムは、一般的なSpring BootおよびJPAのプロジェクト構造を想定していますが、特殊な構造のプロジェクトでは期待通りに動作しない可能性があります。
*   **ファイル読み取り制限**: `CodebaseAnalyzerAgent` は、パフォーマンスとコストを考慮し、一度に読み取るファイル数やファイルサイズに制限を設ける場合があります（現在の実装では最初の数ファイルの内容を重点的に見るなど）。非常に大規模なプロジェクトや、重要な情報が多くのファイルに分散している場合、全ての情報を網羅できない可能性があります。

---
このREADMEが、システムの理解と活用の一助となれば幸いです。 